# 豆瓣电影数据同步功能

## 功能概述

本功能实现了自动从豆瓣网站同步最新电影数据到本地数据库的功能，包括：

1. **自动定时同步**：每8小时自动执行一次同步任务
2. **手动触发同步**：通过HTTP API手动触发同步
3. **两阶段同步**：
   - 第一阶段：获取最新电影列表，保存基本信息
   - 第二阶段：补充电影详情信息（导演、演员、国家等）

## 技术实现

### 文件结构

```
internal/
├── repository/
│   └── video_repository.go        # 视频数据访问层
├── service/
│   └── douban_sync_service.go     # 豆瓣同步业务逻辑
└── handler/
    └── sync.go                    # 同步接口处理器

pkg/infrastructure/scheduler/
└── scheduler.go                   # 定时任务调度器
```

### 定时任务配置

- **执行频率**：每8小时执行一次
- **Cron表达式**：`0 0 */8 * * *`（每8小时的整点执行）
- **自动启动**：服务启动时自动注册并启动定时任务

## 使用方法

### 1. 自动同步（无需操作）

服务启动后，定时任务会自动每8小时执行一次同步。

### 2. 手动触发同步

通过HTTP API手动触发同步任务：

```bash
# 使用 curl 命令
curl -X POST http://localhost:8080/api/sync/douban/movies

# 或使用其他HTTP客户端
POST http://localhost:8080/api/sync/douban/movies
```

**响应示例：**

```json
{
  "code": 0,
  "message": "同步任务已启动，正在后台执行",
  "data": null,
  "trace_id": "xxx-xxx-xxx"
}
```

**注意**：手动触发的同步任务会在后台异步执行，接口会立即返回。

## 数据同步流程

### 第一阶段：同步电影列表

1. 调用豆瓣API获取最新电影列表（40部）
2. 遍历电影列表，检查每部电影是否已存在于数据库
3. 对于不存在的电影，创建新记录并保存以下信息：
   - `source_id`：豆瓣电影ID
   - `source`：数据来源（douban）
   - `title`：电影标题
   - `type`：电影类型
   - `cover_url`：封面图片URL
   - `rating`：评分
   - `episode_count`：集数（电影为0）

### 第二阶段：补充电影详情

1. 从数据库查询需要补充详情的电影（source_id不为空，但year和country为空）
2. 每次处理10部电影，避免请求过于频繁
3. 对每部电影：
   - 访问豆瓣电影详情页面
   - 解析HTML提取以下信息：
     - `director`：导演（多个用逗号分隔）
     - `actors`：主演（多个用逗号分隔）
     - `tags`：类型标签（多个用逗号分隔）
     - `country`：制片国家/地区
     - `year`：上映年份
     - `runtime`：片长（分钟）
     - `imdb_id`：IMDb编号
     - `description`：电影简介
4. 每处理一部电影后休眠2秒，避免请求过快

## 日志查看

同步任务的执行日志会记录在应用日志中：

```bash
# 查看实时日志
tail -f logs/app.log | grep "豆瓣"

# 或查看所有日志
cat logs/app.log
```

**日志示例：**

```
INFO    开始执行豆瓣电影同步任务
INFO    开始同步豆瓣电影数据
INFO    获取到电影列表    {"count": 40}
INFO    保存新电影    {"title": "电影名称", "source_id": 123456}
INFO    电影列表同步完成    {"saved_count": 5}
INFO    找到需要更新详情的电影    {"count": 10}
INFO    更新电影详情成功    {"title": "电影名称", "source_id": 123456}
INFO    豆瓣电影数据同步完成
INFO    豆瓣电影同步任务执行成功
```

## 错误处理

- **网络错误**：如果请求豆瓣失败，会记录错误日志并继续处理下一部电影
- **解析错误**：如果HTML解析失败，会记录错误日志并跳过该电影
- **数据库错误**：如果数据库操作失败，会记录错误日志并继续处理

所有错误都会记录在日志中，不会导致整个同步任务中断。

## 注意事项

1. **请求频率控制**：为避免被豆瓣封禁，详情页请求之间有2秒延迟
2. **数据去重**：通过 `source_id` 字段确保不会重复保存相同电影
3. **增量更新**：只会获取和更新缺少详情信息的电影
4. **Cookie设置**：如果豆瓣接口返回403，可能需要更新请求头中的Cookie

## 配置调整

如果需要调整同步频率，修改 `pkg/infrastructure/scheduler/scheduler.go` 中的 Cron 表达式：

```go
// 当前配置：每8小时执行一次
_, err := cronScheduler.AddFunc("0 0 */8 * * *", func() {
    // ...
})

// 修改示例：
// 每4小时执行：  "0 0 */4 * * *"
// 每12小时执行： "0 0 */12 * * *"
// 每天凌晨2点：  "0 0 2 * * *"
```

## 监控指标

可以通过Prometheus监控接口查看同步任务的执行情况：

```bash
curl http://localhost:8080/metrics | grep douban
```

## 故障排查

### 1. 同步任务没有执行

- 检查服务是否正常启动
- 查看日志确认定时任务是否注册成功
- 确认定时任务调度器已启动

### 2. 获取电影列表失败

- 检查网络连接是否正常
- 确认豆瓣API是否可访问
- 检查请求头配置是否正确

### 3. 电影详情更新失败

- 检查数据库连接是否正常
- 确认HTML解析规则是否正确（豆瓣页面结构可能变化）
- 查看详细错误日志

## 未来改进

1. 支持更多数据源（如TMDB、IMDb等）
2. 添加同步进度查询接口
3. 支持同步历史记录查询
4. 添加同步失败重试机制
5. 支持更细粒度的同步控制（指定电影ID同步）

